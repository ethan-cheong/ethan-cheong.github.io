---
layout: post
title: Plotly in Jekyll
date: 2021-01-02
categories: blog
tag: R
permalink: /plotly-in-jekyll/
htmlwidgets: true

---

I meant for this post to be a kind of proof of concept/precursor to a future post, where I'm planning on implementing a web app with RShiny. Unfortunately, Github pages (which this website is hosted on at the moment) don't let us host Shiny web applications, but we can use Plotly to get a similar effect.

Plotly is a graphing library for R that lets you create interactive visualizations. It's a step up from ggplot2, and even allows some integration with `ggplotly()` which lets you convert ggplot figures to plotly animations.

We're going to write a script that turns code from R markdown to markdown format using the `knitr` package. In the process, it executes all the R code it finds, turns them to html and css and stores them on our blog.

Unfortunately, this means that posts with these visualizations (including this one!) have to be written in R markdown format. Fortunately, this gives us a method for embedding outputs from R directly into our posts, instead of the somewhat archaic method I've been using (taking a screenshot and cropping in paint).

Here's the [link](https://github.com/ethan-cheong/randomWalks/blob/main/mdConverter/mdConverter.R) for the code - in a nutshell, it takes an .Rmd file from the _drafts folder and turns it into a .md file in the _posts folder. It also uses `brocks` to store the dependencies for the visualizations.

Now, in our _drafts folder, we can create an R markdown file and make our blog post. In the YAML front matter, include the following tag (along with everything you'd normally include for a post):

```
---
htmlwidgets: true
---
```

At the moment, this doesn't do anything. We'll have to insert code to tell our site to include our dependencies. Under `_includes/head.html`, add the following code (Credits for this bit goes to Gervasio, who wrote more on this [here](https://g3rv4.com/2017/08/htmlwidgets-jekyll-rstats):
```
{% if page.htmlwidgets %}
  {% assign dep_file = page.url | split: '/' | last | prepend : 'htmlwidgets/' | append : '.html' | replace: '.Rmd', '' %}
  {% include {{dep_file}} %}
{% endif %}
```
Now, when loading up each blog post, our site will check for the htmlwidgets tag.

Finally, when we have visualizations we want to display in our blog, include the code for them in Rmd format, like so:
```
library(ggplot2)
ggplot(data = diamonds) + 
geom_bar(aes(x=cut,fill=cut))
```

We can then run `mdConverter.R`, which makes a post with the following chart:
```{r}
library(plotly)
plot_ly(
  data = mpg,
  x = ~cty,
  y = ~hwy
)
```

Here's something more interesting, with the code taken from the [plotly documentation](https://plotly.com/r/bubble-charts/):
```{r}
library(plotly)

data <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/gapminderDataFiveYear.csv")

data_2007 <- data[which(data$year == 2007),]
data_2007 <- data_2007[order(data_2007$continent, data_2007$country),]
slope <- 2.666051223553066e-05
data_2007$size <- sqrt(data_2007$pop * slope)
colors <- c('#4AC6B7', '#1972A4', '#965F8A', '#FF7070', '#C61951')

fig <- plot_ly(data_2007, x = ~gdpPercap, y = ~lifeExp, color = ~continent, size = ~size, colors = colors,
        type = 'scatter', mode = 'markers', sizes = c(min(data_2007$size), max(data_2007$size)),
        marker = list(symbol = 'circle', sizemode = 'diameter',
                      line = list(width = 2, color = '#FFFFFF')),
        text = ~paste('Country:', country, '<br>Life Expectancy:', lifeExp, '<br>GDP:', gdpPercap,
                      '<br>Pop.:', pop))
fig <- fig %>% layout(title = 'Life Expectancy v. Per Capita GDP, 2007',
         xaxis = list(title = 'GDP per capita (2000 dollars)',
                      gridcolor = 'rgb(255, 255, 255)',
                      range = c(2.003297660701705, 5.191505530708712),
                      type = 'log',
                      zerolinewidth = 1,
                      ticklen = 5,
                      gridwidth = 2),
         yaxis = list(title = 'Life Expectancy (years)',
                      gridcolor = 'rgb(255, 255, 255)',
                      range = c(36.12621671352166, 91.72921793264332),
                      zerolinewidth = 1,
                      ticklen = 5,
                      gridwith = 2),
         paper_bgcolor = 'rgb(243, 243, 243)',
         plot_bgcolor = 'rgb(243, 243, 243)')

fig
```

For my more financially-oriented friends, we can make some interactive candlestick charts with the help of `quantmod`.

```{r}
library(plotly)
library(quantmod)
# get data
getSymbols("AAPL",src='yahoo')
df <- data.frame(Date=index(AAPL),coredata(AAPL))

# create Bollinger Bands
# join and subset data
df <- subset(cbind(df, data.frame(bbands[,1:3])), Date >= "2019-01-01")

# colors column for increasing and decreasing
for (i in 1:length(df[,1])) {
  if (df$AAPL.Close[i] >= df$AAPL.Open[i]) {
    df$direction[i] = 'Increasing'
  } else {
    df$direction[i] = 'Decreasing'
  }
}

i <- list(line = list(color = '#17BECF'))
d <- list(line = list(color = '#7F7F7F'))

# plot candlestick chart

fig <- df %>% plot_ly(x = ~Date, type="candlestick",
                      open = ~AAPL.Open, close = ~AAPL.Close,
                      high = ~AAPL.High, low = ~AAPL.Low, name = "AAPL",
                      increasing = i, decreasing = d) 
fig <- fig %>% add_lines(x = ~Date, y = ~up , name = "B Bands",
                         line = list(color = '#ccc', width = 0.5),
                         legendgroup = "Bollinger Bands",
                         hoverinfo = "none", inherit = F) 
fig <- fig %>% add_lines(x = ~Date, y = ~dn, name = "B Bands",
                         line = list(color = '#ccc', width = 0.5),
                         legendgroup = "Bollinger Bands", inherit = F,
                         showlegend = FALSE, hoverinfo = "none") 
fig <- fig %>% add_lines(x = ~Date, y = ~mavg, name = "Mv Avg",
                         line = list(color = '#E377C2', width = 0.5),
                         hoverinfo = "none", inherit = F) 
fig <- fig %>% layout(yaxis = list(title = "Price"))

# plot volume bar chart
fig2 <- df 
fig2 <- fig2 %>% plot_ly(x=~Date, y=~AAPL.Volume, type='bar', name = "AAPL Volume",
                         color = ~direction, colors = c('#17BECF','#7F7F7F')) 
fig2 <- fig2 %>% layout(yaxis = list(title = "Volume"))

# create rangeselector buttons
rs <- list(visible = TRUE, x = 0.5, y = -0.055,
           xanchor = 'center', yref = 'paper',
           font = list(size = 9),
           buttons = list(
             list(count=1,
                  label='RESET',
                  step='all'),
             list(count=1,
                  label='1 YR',
                  step='year',
                  stepmode='backward'),
             list(count=3,
                  label='3 MO',
                  step='month',
                  stepmode='backward'),
             list(count=1,
                  label='1 MO',
                  step='month',
                  stepmode='backward')
           ))

# subplot with shared x axis
fig <- subplot(fig, fig2, heights = c(0.7,0.2), nrows=2,
               shareX = TRUE, titleY = TRUE)
fig <- fig %>% layout(title = paste("APPLE: 2019-01-01 -",Sys.Date()),
                      xaxis = list(rangeselector = rs),
                      legend = list(orientation = 'h', x = 0.5, y = 1,
                                    xanchor = 'center', yref = 'paper',
                                    font = list(size = 10),
                                    bgcolor = 'transparent'))

fig
```

Finally, we can plot some 3D charts as well:
```{r}
library(plotly)

fig <- plot_ly(mtcars, x = ~wt, y = ~hp, z = ~qsec,
               marker = list(color = ~mpg, colorscale = c('#FFE1A1', '#683531'), showscale = TRUE))
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'Weight'),
                                   yaxis = list(title = 'Gross horsepower'),
                                   zaxis = list(title = '1/4 mile time')),
                      annotations = list(
                        x = 1.13,
                        y = 1.05,
                        text = 'Miles/(US) gallon',
                        xref = 'paper',
                        yref = 'paper',
                        showarrow = FALSE
                        ))
fig
```
